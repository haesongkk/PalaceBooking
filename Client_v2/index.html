<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>팔레스 재방문 할인예약</title>
    <style>
        :root {
            --bg: #F9FAFB;
            --surface: #FFFFFF;
            --ink: #1F2937;
            --muted: #6B7280;
            --brand: #3B82F6;
            --brand-2: #6366F1;
            --accent: #F59E0B;
            --line: #E5E7EB;
            --navy: #111827;
        }

        *, *::before, *::after {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font: 16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif
        }

        .site-header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: var(--surface);
            border-bottom: 1px solid var(--line)
        }

        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 14px 16px;
            display: grid;
            place-items: center;
            text-align: center
        }

        .title {
            margin: 0;
            font-weight: 800;
            letter-spacing: -0.02em;
            font-size: clamp(18px,3.6vw,28px)
        }

            .title span {
                background: linear-gradient(90deg,var(--brand),var(--brand-2));
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent
            }

        :root {
            --footer-space: 96px;
        }

        #pageMain {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 16px var(--footer-space) 16px; /* 하단 여백을 변수로 */
        }

        html {
            scroll-padding-bottom: var(--footer-space);
        }

        .intro {
            text-align: center;
            margin: 24px 0;
            color: var(--muted)
        }

        /* ===== Calendar (Refined palette) ===== */
        .calendar {
            background: var(--surface);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 16px;
            max-width: 420px;
            margin: 0 auto;
            box-shadow: 0 6px 20px rgba(0,0,0,.06)
        }

        .cal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px
        }

            .cal-header button {
                background: #fff;
                border: 1px solid var(--line);
                cursor: pointer;
                font-size: 18px;
                color: var(--ink);
                width: 36px;
                height: 36px;
                border-radius: 10px
            }

                .cal-header button:hover {
                    background: #F3F4F6
                }

        .cal-title {
            font-weight: 800;
            letter-spacing: -0.01em
        }

        /* Grid helpers */
        .grid {
            display: grid;
            gap: 8px
        }

        .grid-7 {
            grid-template-columns: repeat(7,1fr)
        }

        /* Week row */
        .cal-week {
            color: var(--muted);
            text-align: center;
            font-weight: 600
        }

        /* Days grid */
        .cal-grid {
            display: grid;
            gap: 8px
        }

        .day {
            width: 100%;
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--line);
            border-radius: 12px;
            background: #FFFFFF;
            color: #374151; /* slate-700 */
            cursor: pointer;
            user-select: none;
            font-weight: 600;
            transition: background .15s ease, transform .12s ease, box-shadow .15s ease, border-color .15s ease
        }

            .day:hover {
                background: #F3F4F6;
                transform: translateY(-1px);
                box-shadow: 0 6px 16px rgba(0,0,0,.06)
            }

            /* Past days */
            .day[aria-disabled="true"] {
                color: #A1A1AA;
                background: #F8FAFC;
                border-style: dashed;
                cursor: not-allowed;
                filter: grayscale(.05)
            }

            /* Today ring */
            .day.today {
                outline: 2px solid color-mix(in hsl, var(--brand) 55%, #ffffff);
                outline-offset: 2px
            }

            /* Selected */
            .day.selected {
                background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%);
                color: #fff;
                border-color: transparent;
                box-shadow: 0 10px 22px rgba(59,130,246,.25)
            }

        /* Popup highlight */
        .date-highlight {
            padding: 2px 8px;
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            color: #fff;
            font-weight: 800;
            border-radius: 8px
        }

        /* Utility */
        .popup {
            margin-top: 16px;
            padding: 12px;
            border-radius: 10px;
            background: #EEF2FF;
            border: 1px solid var(--brand-2);
            color: var(--navy);
            display: none;
            white-space: pre-line
        }

            .popup.show {
                display: block;
                animation: fade .25s ease
            }

        @keyframes fade {
            from {
                opacity: 0;
                transform: translateY(-6px)
            }

            to {
                opacity: 1;
                transform: none
            }
        }
        /* 선택 패널 표시/숨김 */
        .selection-panel {
            display: none; /* 기본은 접힘 */
            margin-top: 16px;
            padding: 12px;
            border-radius: 10px;
            background: #EEF2FF;
            border: 1px solid var(--brand-2);
            color: var(--navy);
        }
        .selection-panel.open {
            display: block; /* open 클래스가 붙으면 펼쳐짐 */
            animation: fade .25s ease;
        }

        /* 스텝퍼 줄 */
        .stepper-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        /* -, + 공용 버튼 */
        .btn {
            background: #fff;
            border: 1px solid var(--line);
            cursor: pointer;
            font-size: 16px;
            color: var(--ink);
            min-width: 36px;
            height: 36px;
            border-radius: 10px;
            padding: 0 10px;
            user-select: none;
        }

            .btn:hover {
                background: #F3F4F6;
            }

            .btn[disabled] {
                opacity: .5;
                cursor: not-allowed;
            }

        /* 숙박일 표시 */
        .nights-badge {
            min-width: 72px;
            text-align: center;
            font-weight: 800;
            padding: 6px 10px;
            border-radius: 8px;
            background: #EEF2FF;
            border: 1px solid var(--brand-2);
            color: var(--navy);
        }

        /* 확정 버튼 */
        .confirm-btn {
            margin-left: auto; /* 오른쪽 끝으로 밀기 */
        }

        /* 달력 잠금(확정 후) */
        .calendar.locked {
            pointer-events: none; /* 클릭 막기 */
            opacity: .75; /* 잠금 시각 피드백 */
        }

        .cal-header button[disabled] {
            opacity: .5;
            cursor: not-allowed;
        }
        /* 날짜 확정 후 요약 출력 */
        .after-confirm {
            display: none; /* 기본 숨김 */
            margin-top: 12px;
            padding: 12px;
            border-radius: 10px;
            background: #FFFFFF;
            border: 1px dashed var(--line);
            color: var(--navy);
            white-space: pre-line; /* \n 줄바꿈 반영 */
        }

            .after-confirm.show {
                display: block;
                animation: fade .25s ease;
            }

        /* 객실 리스트 */
        .room-list {
            display: none; /* 기본 숨김 */
            margin-top: 12px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .room-list.show {
            display: grid;
        }

        .room-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid var(--line);
            background: var(--surface);
            border-radius: 12px;
            cursor: pointer;
            transition: box-shadow .15s, transform .12s, border-color .15s;
        }

        .room-card:hover {
            background: #F9FAFB;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0,0,0,.06);
        }

        .room-card.selected {
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(59,130,246,.15);
        }

        .room-card:disabled {
            opacity: .5;
        }
        .room-name:disabled {
            opacity: .5;
        }
        .price:disabled {
            opacity: .5;
        }
        

        .room-name {
            font-weight: 700;
        }

        .discount-badge {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 999px;
            background: #ECFDF5;
            border: 1px solid #A7F3D0;
            color: #065F46;
            margin-left: 8px;
        }

        .price {
            margin-left: auto;
            text-align: right;
        }

        .price .orig {
            color: var(--muted);
            text-decoration: line-through; /* 정가 취소선 */
            font-weight: 600;
            display: block;
        }

        .price .sale {
            font-weight: 800;
            font-size: 18px;
            background: linear-gradient(90deg, var(--brand), var(--brand-2));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent; /* 할인가 강조 */
        }

        /* 객실 선택 후 토글(요약 + 폰번호 입력) */
        .booking-toggle {
            display: none; /* 기본 숨김 */
            margin-top: 12px;
            padding: 12px;
            border-radius: 12px;
            background: #FFFFFF;
            border: 1px solid var(--line);
            color: var(--navy);
        }

            .booking-toggle.open {
                display: block;
                animation: fade .25s ease;
            }

        /* 강조 박스 */
        .highlight-box {
            padding: 12px;
            border-radius: 10px;
            background: #EEF2FF;
            border: 1px solid var(--brand-2);
            margin-bottom: 12px;
        }

        .highlight-box .period {
            font-weight: 800;
            margin: 0 0 6px 0;
        }

        .highlight-box .pay {
            margin: 0;
        }

        .emph-room {
            font-weight: 900;
            background: linear-gradient(90deg, var(--brand), var(--brand-2));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent; /* 룸명 강조 */
        }

        .pay-amount {
            font-weight: 900;
            font-size: 18px;
        }

        /* 폰번호 입력 줄 */
        .phone-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 6px;
        }

        .input {
            flex: 1;
            height: 36px;
            padding: 0 10px;
            border: 1px solid var(--line);
            border-radius: 10px;
            font-size: 16px;
        }

        .input:focus {
            outline: 2px solid color-mix(in hsl, var(--brand) 55%, #fff);
            outline-offset: 1px;
        }

            .input[disabled] {
                background: #F3F4F6;
                color: var(--muted);
                cursor: not-allowed;
            }

        .small-note {
            display: block;
            margin-top: 6px;
            color: var(--muted);
            font-size: 12px;
        }

        /* 전송 성공 안내 */
        .success-note {
            display: none;
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            background: #ECFDF5;
            border: 1px solid #A7F3D0;
            color: #065F46;
            font-weight: 600;
        }

            .success-note.show {
                display: block;
                animation: fade .25s ease;
            }

        /* 고정 하단바 */
        .footer-bar {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 70;
            background: var(--surface);
            border-top: 1px solid var(--line);
            padding: 10px max(12px, env(safe-area-inset-left)) calc(10px + env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-right));
            box-shadow: 0 -6px 20px rgba(0,0,0,.06);
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .fbtn {
            height: 44px;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: #fff;
            color: var(--ink);
            font-weight: 700;
            cursor: pointer;
        }

        .fbtn:hover {
            background: #F3F4F6;
        }

        .fbtn[disabled] {
            opacity: .5;
            cursor: not-allowed;
        }

        :root {
            --footer-space: 96px;
        }
        /* 기본값(초기 로드용) */
        main {
            padding-bottom: var(--footer-space);
        }
        /* scrollIntoView 등이 하단바에 가리지 않도록 */
        html {
            scroll-padding-bottom: var(--footer-space);
        }
       
    </style>
</head>
<body>
    <header class="site-header"><div class="header-inner"><h1 class="title"><span>팔레스 재방문 할인예약</span></h1></div></header>

    <!--<main style="padding:24px 16px; max-width:1200px; margin:0 auto;">-->
    <main id="pageMain">
        <!-- 안내 텍스트 -->
        <section class="stack" style="--stack-gap:12px; text-align:center; margin-bottom:20px;">
            <p style="margin:0; color:var(--ink); font-weight:600;">팔레스 호텔을 다시 찾아주셔서 감사합니다.</p>
            <p style="margin:0; color:var(--muted);">캘린더에서 체크인 날짜를 선택해주세요.</p>
        </section>

        <!-- 달력 컴포넌트 -->
        <section class="calendar card" aria-label="체크인 날짜 선택">
            <div class="cal-header">
                <button class="cal-nav" id="btnPrev" aria-label="이전 달 보기" type="button" title="이전 달">&#x2039;</button>
                <div class="cal-title" id="calTitle" aria-live="polite"></div>
                <button class="cal-nav" id="btnNext" aria-label="다음 달 보기" type="button" title="다음 달">&#x203A;</button>
            </div>
            <div class="cal-week grid grid-7" aria-hidden="true">
                <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
            </div>
            <div class="cal-grid grid grid-7" id="calGrid"></div>
        </section>

        <!-- 선택 패널 (토글 전개/접힘) -->
        <section class="selection-panel" id="selectionPanel" aria-live="polite">
            <div class="selection-inner">
                <p id="selectionText" class="selection-text"></p>
                <p class="selection-sub">몇 박을 하실 예정인가요? <span class="muted">(대실은 0박)</span></p>
            </div>
            <div class="stepper-row">
                <button type="button" id="btnMinus" class="btn" aria-label="하루 감소">−</button>
                <span id="nightsBadge" class="nights-badge"><strong><span id="nightsCount">0</span>박</strong></span>
                <button type="button" id="btnPlus" class="btn" aria-label="하루 증가">+</button>

                <button type="button" id="btnConfirm" class="btn confirm-btn">확정</button>
            </div>
        </section>
        <!-- 확정 후 안내 -->
        <section id="afterConfirm" class="after-confirm" aria-live="polite"></section>
        <!-- 객실 선택 목록 -->
        <section id="roomList" class="room-list" aria-label="객실 선택 목록"></section>
        <!-- 객실 선택 토글(요약 + 폰번호) -->
        <section id="bookingToggle" class="booking-toggle" aria-live="polite" aria-hidden="true">
            <div id="bookingSummary" class="highlight-box">
                <!-- JS에서 채움 -->
            </div>

            <p style="margin:0 0 6px 0;">위와 같이 선택하셨습니다.<br><br></p>
            <p style="margin:0 0 8px 0;">예약이 확정되면 문자로 알려드립니다.<br>회신받을 휴대전화번호를 입력해주세요.</p>

            <div class="phone-row">
                <input id="phoneInput" class="input" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="숫자만 입력" maxlength="11" aria-label="휴대전화번호(숫자만)">
                <button id="btnSend" class="btn" type="button" disabled>전송</button>
            </div>
            <div id="sendResult" class="success-note" role="status" aria-live="polite"></div>
            <small class="small-note">휴대전화번호는 팔레스호텔 예약에만 사용됩니다.</small>
        </section>
    </main>
    <!-- 고정 하단바 -->
    <nav class="footer-bar" aria-label="빠른 작업">
        <div class="footer-grid">
            <button id="btnStartOver" class="fbtn" type="button">처음부터 다시</button>
            <button id="btnRoomsInfo" class="fbtn" type="button">객실 소개</button>
            <button id="btnHistory" class="fbtn" type="button">예약 내역</button>
        </div>
    </nav>
    <script>
        (function () {
            const titleEl = document.getElementById('calTitle');
            const gridEl = document.getElementById('calGrid');
            const prevBtn = document.getElementById('btnPrev');
            const nextBtn = document.getElementById('btnNext');
            const panel = document.getElementById('selectionPanel');
            const textEl = document.getElementById('selectionText');
            const afterEl = document.getElementById('afterConfirm'); // 날짜 확정 후 요약 출력 영역

            // 객실 가격 리스트 컨테이너
            const roomListEl = document.getElementById('roomList');
            // 객실 선택 토글(요약 + 폰번호)
            const bookingToggle = document.getElementById('bookingToggle');
            const bookingSummary = document.getElementById('bookingSummary');
            const phoneInput = document.getElementById('phoneInput');
            const sendBtn = document.getElementById('btnSend');
            const sendResult = document.getElementById('sendResult');

            // 고정 하단바 버튼
            const btnStartOver = document.getElementById('btnStartOver');
            const btnRoomsInfo = document.getElementById('btnRoomsInfo');
            const btnHistory = document.getElementById('btnHistory');

            let selectedRoom = null;

            function daysText(n) {
                return `${n}박 ${n + 1}일`;
            }
            function formatKRW(n) { return n.toLocaleString('ko-KR') + '원'; }
            function discountRate(orig, sale) { return Math.round((1 - sale / orig) * 100); }

            // 스텝퍼 & 확정
            const minusBtn = document.getElementById('btnMinus');
            const plusBtn = document.getElementById('btnPlus');
            const confirmBtn = document.getElementById('btnConfirm');
            const nightsEl = document.getElementById('nightsCount');
            const calendarEl = document.querySelector('.calendar');

            let nights = 1;
            let isConfirmed = false;
            let calendarLocked = false;

            function updateStepperUI() {
                nightsEl.textContent = String(nights);

                // 마이너스는 0 이하로 못 내려가게
                minusBtn.disabled = isConfirmed || (nights <= 0);
                plusBtn.disabled = isConfirmed;

                // 날짜가 선택되어 있어야 확정 가능
                confirmBtn.disabled = isConfirmed || !selectedDate;
            }

            function setCalendarLocked(lock) {
                calendarLocked = lock;
                if (lock) {
                    calendarEl.classList.add('locked');
                    prevBtn.setAttribute('disabled', '');
                    nextBtn.setAttribute('disabled', '');
                    // 패널은 계속 펼침 유지
                    panel.classList.add('open');
                    panel.setAttribute('data-locked', 'true');
                } else {
                    calendarEl.classList.remove('locked');
                    prevBtn.removeAttribute('disabled');
                    nextBtn.removeAttribute('disabled');
                    panel.removeAttribute('data-locked');
                }
            }
            // 하단바 버튼
            function resetFlow() {
                // 상태 초기화
                isConfirmed = false;
                calendarLocked = false;
                selectedDate = null;
                selectedRoom = null;
                nights = 1;

                // UI 초기화
                setCalendarLocked(false);

                // 선택 패널
                panel.classList.remove('open');
                panel.removeAttribute('data-locked');
                panel.removeAttribute('aria-hidden');
                textEl.textContent = '';

                // 확정 요약
                afterEl.textContent = '';
                afterEl.classList.remove('show');

                // 객실 목록/토글
                if (roomListEl) {
                    roomListEl.innerHTML = '';
                    roomListEl.classList.remove('show');
                }
                if (bookingToggle) {
                    bookingToggle.classList.remove('open');
                    bookingToggle.setAttribute('aria-hidden', 'true');
                }
                if (bookingSummary) bookingSummary.innerHTML = '';

                // 전화번호
                if (phoneInput) {
                    phoneInput.value = '';
                    phoneInput.disabled = false;
                }
                if (sendBtn) {
                    sendBtn.textContent = '전송';
                    sendBtn.disabled = true;
                }
                if (typeof sendResult !== 'undefined' && sendResult) {
                    sendResult.classList.remove('show');
                    sendResult.textContent = '';
                }

                // 캘린더 재렌더
                render();

                // 스텝퍼 상태 반영
                updateStepperUI();

                // 화면 맨 위로
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // 객실 선택 박스
            function renderRooms() {
                roomListEl.innerHTML = '';
                const dateStr = selectedDate.getFullYear() + '-' + (selectedDate.getMonth() + 1) + '-' + selectedDate.getDate();
                fetch('/api/client/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: dateStr,
                        night: nights
                    })
                }).then(res => res.json()).then(data => data.rooms.forEach(r => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'room-card';
                    btn.setAttribute('data-id', r.id);

                    console.log(r.slots);

                    let status = true;
                    for(const s of r.slots) {
                        if(s.status == 0) {
                            status = false;
                            break;
                        }
                    }
                    btn.disabled = !status;

                    const orig = r.slots.reduce((acc, s) => acc < Number(s.price) ? acc : Number(s.price || Number.MAX_SAFE_INTEGER), Number.MAX_SAFE_INTEGER);
                    const sale = orig - r.discount;
                    const rate = discountRate(orig, sale); 
                    const total = r.slots.reduce((acc, s) => acc + (Number(s.price) - Number(r.discount) || 0), 0);
                    btn.innerHTML = `
                    <div class="room-name">
                        ${r.name}
                        ${rate > 0 ? `<span class="discount-badge">-${rate}%</span>` : ''}
                    </div>
                    <div class="price">
                        <span class="orig">${formatKRW(orig)}</span>
                        <span class="sale">${formatKRW(sale)}</span>
                    </div>
                `;

                    btn.addEventListener('click', () => {
                        if (!isConfirmed) return; // 날짜/박수 확정 전엔 객실 선택 불가

                        const isSame = selectedRoom && selectedRoom.id === r.id;
                        const isOpen = bookingToggle.classList.contains('open');

                        // 같은 카드를 다시 누르면 닫기(캘린더 토글과 동일한 UX)
                        if (isSame && isOpen) {
                            selectedRoom = null;
                            bookingToggle.classList.remove('open');
                            bookingToggle.setAttribute('aria-hidden', 'true');
                            // 선택 강조 해제
                            roomListEl.querySelectorAll('.room-card.selected')
                                .forEach(el => el.classList.remove('selected'));
                            // 입력 초기화
                            phoneInput.value = '';
                            sendBtn.disabled = true;
                            return;
                        }

                        // 다른 카드 선택 or 닫혀있던 경우 → 열고 내용 갱신
                        selectedRoom = r;

                        // 강조표시 스위칭
                        roomListEl.querySelectorAll('.room-card.selected')
                            .forEach(el => el.classList.remove('selected'));
                        btn.classList.add('selected');

                        // 요약 내용 업데이트
                        const checkout = addDays(selectedDate, nights); // 종료일 = 체크인 + 박수
                        bookingSummary.innerHTML = `
                <p class="period">${formatLabel(selectedDate)} - ${formatLabel(checkout)} ${daysText(nights)}</p>
                <p class="pay"><span class="emph-room">${r.name}</span> 결제금액: <span class="pay-amount">${formatKRW(total)}</span></p>
            `;

                        bookingToggle.classList.add('open');
                        bookingToggle.removeAttribute('aria-hidden');

                        // 가시성 보장(아래로 살짝 스크롤)
                        bookingToggle.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    });

                    roomListEl.appendChild(btn);
                }));
                roomListEl.classList.add('show'); // 표시
            }

            function addDays(date, days) {
                return new Date(date.getFullYear(), date.getMonth(), date.getDate() + days);
            }

            // 달력
            const WEEK = ['일', '월', '화', '수', '목', '금', '토'];

            // 오늘 기준(시간 제거)
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            let viewYear = today.getFullYear();
            let viewMonth = today.getMonth(); // 0~11
            let selectedDate = null; // 실제 Date 객체 저장

            function formatLabel(d) {
                const m = d.getMonth() + 1;
                const day = d.getDate();
                const wk = WEEK[d.getDay()];
                return `${m}월 ${day}일 (${wk})`;
            }

            function daysInMonth(y, m) {
                return new Date(y, m + 1, 0).getDate();
            }

            function render() {
                titleEl.textContent = `${viewYear}년 ${viewMonth + 1}월`;
                gridEl.innerHTML = '';

                const firstWeekday = new Date(viewYear, viewMonth, 1).getDay();
                const totalDays = daysInMonth(viewYear, viewMonth);

                // 앞 공백(지난달 자리 채우기)
                for (let i = 0; i < firstWeekday; i++) {
                    const spacer = document.createElement('div');
                    gridEl.appendChild(spacer);
                }

                for (let day = 1; day <= totalDays; day++) {
                    const date = new Date(viewYear, viewMonth, day);
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'day';
                    btn.textContent = day;

                    const isPast = date < today;
                    if (isPast) {
                        btn.setAttribute('aria-disabled', 'true');
                    } else {
                        btn.addEventListener('click', () => onPick(date, btn));
                    }

                    if (date.getTime() === today.getTime()) {
                        btn.classList.add('today');
                    }
                    if (selectedDate && sameYMD(date, selectedDate)) {
                        btn.classList.add('selected');
                    }

                    gridEl.appendChild(btn);
                }
            }

            function sameYMD(a, b) {
                return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
            }

            function onPick(date, btn) {
                if (calendarLocked) return; // 확정 누르면 달력 클릭 막기

                if (selectedDate && sameYMD(date, selectedDate)) {
                    // 토글: 선택 해제
                    selectedDate = null;
                    panel.classList.remove('open');
                    textEl.textContent = '';                  // 문구 비우기
                    panel.setAttribute('aria-hidden', 'true');// 보조 접근성
                    const prevSel = gridEl.querySelector('.day.selected');
                    if (prevSel) prevSel.classList.remove('selected');
                    return;
                }

                selectedDate = date;
                gridEl.querySelectorAll('.day.selected').forEach(el => el.classList.remove('selected'));
                btn.classList.add('selected');

                textEl.innerHTML = `체크인 날짜로 <span class="date-highlight">${formatLabel(date)}</span> 을(를) 선택하셨습니다.`;
                panel.classList.add('open');
                updateStepperUI(); // 날짜 선택되면 확정 버튼 활성화
                nights = 1;
            }

            prevBtn.addEventListener('click', () => {
                if (calendarLocked) return; // 확정 후 이동 금지
                if (viewMonth === 0) { viewMonth = 11; viewYear--; } else { viewMonth--; }
                render();
            });
            nextBtn.addEventListener('click', () => {
                if (calendarLocked) return; // 확정 후 이동 금지
                if (viewMonth === 11) { viewMonth = 0; viewYear++; } else { viewMonth++; }
                render();
            });

            // 스텝퍼/확정 이벤트 바인딩
            minusBtn.addEventListener('click', () => {
                if (isConfirmed) return;
                nights = Math.max(0, nights - 1);
                updateStepperUI();
            });

            plusBtn.addEventListener('click', () => {
                if (isConfirmed) return;
                nights = nights + 1;
                updateStepperUI();
            });

            confirmBtn.addEventListener('click', () => {
                if (isConfirmed || !selectedDate) return;
                isConfirmed = true;

                // 스텝퍼/확정 비활성 + 달력 잠금
                updateStepperUI();
                setCalendarLocked(true);

                // 접근성/피드백 문구
                // 토글 박스 내부 문구(상단 안내)
                textEl.innerHTML = `체크인 <span class="date-highlight">${formatLabel(selectedDate)}</span>, <strong>${nights}</strong>박으로 확정되었습니다.`;

                // ▼ 토글박스 경계 "아래"에 이어서 출력할 요약
                const checkout = addDays(selectedDate, nights); // 요구사항: N박 N일 기준으로 표기
                const summary = `${formatLabel(selectedDate)} - ${formatLabel(checkout)} ${nights}박 ${nights + 1}일 을 선택하셨습니다.\n이제 객실을 선택해주세요.`;

                afterEl.textContent = summary;      // \n 줄바꿈 위해 textContent 사용
                afterEl.classList.add('show');      // 요약 박스 표시
                renderRooms();                      // 객실 룸 표시
            });

            render();
            updateStepperUI();
            btnStartOver.addEventListener('click', resetFlow);
            
            btnRoomsInfo.addEventListener('click', () => {
                // 객실 목록이 이미 보이면 그 위치로 스크롤
                //if (roomListEl && roomListEl.classList.contains('show')) {
                //    roomListEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                //} else {
                //    // 아직 확정 전이라 목록이 없다면 안내
                //    alert('먼저 날짜와 숙박일을 확정해 주세요.');
                //}
                alert('객실 소개 기능은 준비 중입니다');
            });
            
            btnHistory.addEventListener('click', () => {
                // TODO: 예약 내역 화면으로 연결
                // location.href = '/reservations'; // 실제 라우트가 있다면 이렇게
                alert('예약 내역 기능은 준비 중입니다.');
            });
            // 하단바 높이에 맞춰 본문 하단 여백을 동적으로 설정
            (function () {
                const footer = document.querySelector('.footer-bar');

                function setFooterSpace() {
                    if (!footer) return;
                    const h = Math.ceil(footer.getBoundingClientRect().height);
                    document.documentElement.style.setProperty('--footer-space', (h + 16) + 'px'); // 여유 16px
                }

                // 초기/리사이즈/회전 시 반영
                window.addEventListener('load', setFooterSpace);
                window.addEventListener('resize', setFooterSpace);
                window.addEventListener('orientationchange', setFooterSpace);

                // 폰트 로딩 등으로 높이가 변할 수도 있으니 한 번 더
                setTimeout(setFooterSpace, 0);
            })();

            // 숫자만 허용 + 버튼 활성화
            phoneInput.addEventListener('input', () => {
                // 번호 수정을 허용하는 경우
                //sendResult.classList.remove('show');
                //sendResult.textContent = '';
                //sendBtn.textContent = '전송';
                // 숫자만 남기기
                const onlyDigits = phoneInput.value.replace(/\D/g, '');
                if (phoneInput.value !== onlyDigits) phoneInput.value = onlyDigits;

                // 한국 휴대폰 기준 10~11자리면 전송 가능
                sendBtn.disabled = !(onlyDigits.length >= 10 && onlyDigits.length <= 11);
            });

            sendBtn.addEventListener('click', () => {
                if (sendBtn.disabled) return;

                const dateStr = selectedDate.getFullYear() + '-' + (selectedDate.getMonth() + 1) + '-' + selectedDate.getDate();

                fetch('/api/client/reservation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: dateStr,
                        nights: nights,
                        roomID: selectedRoom.id,
                        customerID: phoneInput.value
                    })
                }).then(res => res.json()).then(data => {
                    if(data.error) {
                        sendResult.textContent = data.error;
                    } else {
                        sendResult.textContent = '감사합니다. 예약 접수가 완료되었습니다. 최대한 빠르게 예약 확정 여부를 문자로 안내해 드리겠습니다.';
                    }
                    // 버튼 피드백
                    sendBtn.textContent = '전송됨';
                    sendBtn.disabled = true;
                    phoneInput.disabled = true;      // 입력창 비활성화
                    phoneInput.blur();               // 커서도 제거

                    // 전송 성공 안내 문구 출력
                    sendResult.classList.add('show');
                });
                
                

                //btnStartOver.addEventListener('click', resetFlow);

                //btnRoomsInfo.addEventListener('click', () => {
                //    // 객실 목록이 이미 보이면 그 위치로 스크롤
                //    if (roomListEl && roomListEl.classList.contains('show')) {
                //        roomListEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                //    } else {
                //        // 아직 확정 전이라 목록이 없다면 안내
                //        alert('먼저 날짜와 숙박일을 확정해 주세요.');
                //    }
                //});

                //btnHistory.addEventListener('click', () => {
                //    // TODO: 예약 내역 화면으로 연결
                //    // location.href = '/reservations'; // 실제 라우트가 있다면 이렇게
                //    alert('예약 내역 기능은 준비 중입니다.');
                //});
            });
        })();

    </script>
</body>
</html>
